name: Build macOS Qt (arm64)

on:
  push:
    branches: ["main"]

jobs:
  build-macos:
    runs-on: macos-14   # Apple Silicon runner

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Python & AQT
      run: |
        python3 -m pip install --upgrade pip
        pip3 install aqtinstall

    - name: Install Qt 6.5.3 (arm64)
      run: |
        aqt install-qt mac desktop 6.5.3 clang_64 --outputdir Qt

    - name: Configure CMake
      run: |
        cmake -S . -B build \
        -DCMAKE_PREFIX_PATH="$GITHUB_WORKSPACE/Qt/6.5.3/macos" \
        -DCMAKE_OSX_ARCHITECTURES=arm64

    - name: Build
      run: cmake --build build --parallel

    - name: Deploy Qt Dependencies into .app
      run: |
        $GITHUB_WORKSPACE/Qt/6.5.3/macos/bin/macdeployqt build/apptest_qt.app

    - name: Create .dmg Installer
      run: |
        hdiutil create build/apptest_qt.dmg \
          -volname "apptest_qt" \
          -srcfolder build/apptest_qt.app \
          -ov -format UDZO

    - name: Upload .app Artifact
      uses: actions/upload-artifact@v4
      with:
        name: apptest_qt-app
        path: build/apptest_qt.app

    - name: Upload .dmg Installer Artifact
      uses: actions/upload-artifact@v4
      with:
        name: apptest_qt-dmg
        path: build/apptest_qt.dmg

