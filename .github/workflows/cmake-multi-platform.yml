name: Build Qt App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:

  linux-build:
  runs-on: ubuntu-latest

  steps:
    - uses: actions/checkout@v3

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          mesa-common-dev \
          libglu1-mesa-dev \
          libglib2.0-dev \
          libxkbcommon-dev \
          libxkbcommon-x11-dev \
          libegl1-mesa-dev \
          libgl1-mesa-dev

    - name: Remove old Qt (if any)
      run: rm -rf Qt

    - name: Install Python & aqt
      run: |
        python3 -m pip install --upgrade pip
        pip install aqtinstall

    - name: Install Qt 6.8.3 for Linux
      run: |
        aqt install-qt linux desktop 6.8.3 gcc_64 \
          --modules qtbase qtdeclarative qtquickcontrols2 qtmultimedia \
          --outputdir Qt

    - name: Configure CMake
      run: |
        cmake -S . -B build \
          -DCMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/Qt/6.8.3/gcc_64

    - name: Build
      run: cmake --build build --parallel

    - name: Package .AppImage
      run: |
        mkdir -p appdir/usr/bin
        cp build/YourAppExecutableName appdir/usr/bin/
        chmod +x appdir/usr/bin/YourAppExecutableName

        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage

        ./linuxdeploy-x86_64.AppImage --appdir appdir --output appimage

    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: Linux-AppImage
        path: "*.AppImage"


