name: Build Qt AppImage

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Install Qt 6.5.3
        uses: jurplel/install-qt-action@v3
        with:
          version: "6.5.3"
          host: linux
          target: desktop
          arch: gcc_64
          modules: qtquick

      - name: Install required system libs
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 patchelf libxcb-cursor0

      - name: Configure and build (Release)
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          cmake --build . --config Release

      - name: Set EXE path
        run: echo "EXE=build/apptest_qt" >> $GITHUB_ENV

      - name: Download deployment tools
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x linuxdeploy-*.AppImage appimagetool-x86_64.AppImage

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          cp "$EXE" AppDir/usr/bin/

          cp deploy/app.png AppDir/usr/share/icons/hicolor/256x256/apps/app.png

          cat <<EOF > AppDir/usr/share/applications/app.desktop
[Desktop Entry]
Name=apptest_qt
Exec=apptest_qt
Icon=app
Type=Application
Categories=Utility;
EOF

      - name: Build AppImage
        run: |
          QT_DIR="$GITHUB_WORKSPACE/Qt/6.5.3/gcc_64"
          QML_PATH="build/Desktop_Qt_6_5_3_GCC_64bit-Release/test_qt"

          ./linuxdeploy-x86_64.AppImage --appdir AppDir

          ./linuxdeploy-plugin-qt-x86_64.AppImage \
            --appdir AppDir \
            --qt-path "$QT_DIR" \
            --qml-import-path "$QML_PATH"

          ./appimagetool-x86_64.AppImage AppDir

      - name: Upload AppImage
        uses: actions/upload-artifact@v3
        with:
          name: apptest_qt-AppImage
          path: ./*.AppImage

