name: Build Qt AppImage (Linux)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    env:
      QT_VERSION: "6.5.3"
      APP_NAME: "MyQtApp"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake fuse wget patchelf libfuse2

      - name: Install Qt
        run: |
          pip install aqtinstall
          aqt install-qt linux desktop $QT_VERSION gcc_64 --outputdir $HOME/Qt

      - name: Configure & Build
        run: |
          mkdir build && cd build
          cmake .. -DCMAKE_PREFIX_PATH="$HOME/Qt/$QT_VERSION/gcc_64"
          cmake --build . --config Release

      - name: Set Executable Path
        run: echo "EXE=$(find build -type f -executable | head -n 1)" >> $GITHUB_ENV

      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps

          cp "$EXE" AppDir/usr/bin/$APP_NAME
          chmod +x AppDir/usr/bin/$APP_NAME

          # Icon
          cp deploy/app.png AppDir/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png

          # Desktop File
          cat <<EOF > AppDir/usr/share/applications/$APP_NAME.desktop
          [Desktop Entry]
          Name=$APP_NAME
          Exec=$APP_NAME
          Icon=$APP_NAME
          Type=Application
          Categories=Utility;
          EOF

      - name: Download linuxdeployqt
        run: |
          wget -O linuxdeployqt https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-x86_64.AppImage
          chmod +x linuxdeployqt

      - name: Deploy AppDir
        run: |
          ./linuxdeployqt AppDir/usr/share/applications/$APP_NAME.desktop \
            -qmldir=. \
            -appimage

      - name: Upload AppImage Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.APP_NAME }}-AppImage
          path: ./*.AppImage

